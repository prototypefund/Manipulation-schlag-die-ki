<app>
    <header></header>

    <intro if={state.intro.mounted} onclick={state.intro.onclick}></intro>

    <!-- these will all mount into main grid area -->
    <countdown if={state.countdown.mounted} round={state.countdown.round} length=3 ontimeout={state.countdown.ontimeout}></countdown>
    <challenge if={state.challenge.mounted} image={state.challenge.image} noise={state.challenge.noise}></challenge>
    <overlay if={state.overlay.mounted}></overlay>
    <instructions if={state.instructions.mounted} text={state.instructions.text}></instructions>

    <!-- these will all mount into sub grid area -->
    <confirm if={state.confirm.mounted} onclick={state.confirm.onclick}></confirm>
    <answers if={state.answers.mounted} disabled={state.answers.disabled} answers={state.answers.answers} correct={state.answers.correct} onselected={state.answers.onselected}></answers>

    <footer></footer>


    <script>
        let app = this;

        // state of all tags on this site, filled with default values
        app.state = {};
        app.state.intro        = {"mounted": false, "onclick": null};
        app.state.countdown    = {"mounted": false, "ontimeout": null, "round": 0};
        app.state.challenge    = {"mounted": false, "image": null, "noise": null, "timer": null};
        app.state.overlay      = {"mounted": false};
        app.state.instructions = {"mounted": false, "text": null};
        app.state.confirm      = {"mounted": false, "onclick": null};
        app.state.answers      = {"mounted": false, "disabled": true, "answers": null, "correct": null, "onselected": null};

        app.ai = null;

        // which tags are mounted for which screen
        const SCREENS = {"INTRO":     ["intro"],
                         "RULES":     ["instructions", "confirm"],
                         "COUNTDOWN": ["countdown", "answers"],
                         "CHALLENGE": ["challenge", "answers"],
                         "RETRO":     ["overlay", "instructions", "confirm"]};

        app.showScreen = function(screen) {
            let mountedCurrentScreen = t => app.state[t].mounted;
            let mountedNextScreen = t => screen.includes(t);

            // update mounted settings
            for (let tag in app.state) {
                if (mountedCurrentScreen(tag) && !mountedNextScreen(tag))
                    app.state[tag].mounted = false;
                if (!mountedCurrentScreen(tag) && mountedNextScreen(tag))
                    app.state[tag].mounted = true;
            }
            app.update();
        };

        app.showIntro = function () {
            app.state.intro.onclick = app.showRules;
            app.showScreen(SCREENS.INTRO);
        };

        app.showRules = function() {
            app.state.instructions.text = "RULES";
            app.state.confirm.onclick = () => app.startRound(0);
            app.showScreen(SCREENS.RULES);
        };

        app.startRound = function(roundIndex) {
            // configure the challenge
            app.state.countdown.round = roundIndex + 1; // humans count from 1, not from 0
            app.state.challenge.image = opts[roundIndex].image;
            app.state.answers.answers = opts[roundIndex].answers;
            app.state.answers.correct = opts[roundIndex].correct;
            app.state.answers.disabled = true;

            // configure all on-click handlers for this round
            app.state.countdown.ontimeout = app.startChallenge;
            app.state.answers.onselected = app.humanFinished;
            app.state.confirm.onclick = () => app.startRound(roundIndex+1);

            // initial screen for the round
            app.showScreen(SCREENS.COUNTDOWN);
        };

        app.startChallenge = function() {
            app.state.challenge.noise = 1.0;
            app.state.answers.disabled = false;
            app.showScreen(SCREENS.CHALLENGE);

            let img = document.getElementById('canvas');
            app.ai = AI(img, app.state.answers.answers[app.state.answers.correct], app.machineFinished);
            app.ai.predict();

            function reduceNoise() {
              app.state.challenge.noise -= 0.1;
              app.update();
              app.ai.predict();
            }
            app.state.challenge.timer = Timer(200, 10, reduceNoise);
            app.state.challenge.timer.start();
        };

        app.humanFinished = function(result){
            if (result == RESULT.CORRECT) {
                //app.state.ai.disabled = true;
                app.state.instructions.text = "ROUND1_HUMAN_WINS";
                app.showScreen(SCREENS.RETRO);
                app.state.challenge.timer.cancel();
                app.ai.cancel();
                app.ai = null;
            }

        };


        app.machineFinished = function(result){
            if (result == RESULT.CORRECT) {
                app.state.instructions.text = "ROUND1_MACHINE_WINS";
                app.showScreen(SCREENS.RETRO);
                app.state.challenge.timer.cancel();
                app.ai.cancel();
                app.ai = null;
            }
            // todo incorrect
        };

        app.on("mount", app.showRules);

    </script>

</app>

<confirm>
    <button onclick={opts.onclick} class="button-primary">Alles klar!</button>
</confirm>
