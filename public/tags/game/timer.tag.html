<timer>
    <progress value={this.value} max={this.max}></progress>

    <script>
        let tag = this;

        /* parameters given to this tag
        opts.length: Length of the timer (in seconds)
        opts.controller: observable for communicating/controlling status of the timer, supports the following messages
               start: (from parent) trigger start of the timer
               stop: (from parent) trigger stopping of the timer
               timeout: (from this tag) timer has run out
        */
        opts.length = Number(opts.length) || 10;

        // calculate settings for progress bar
        tag.max = opts.length * 1000;  // to milliseconds
        tag.value = 0;
        tag.stepTime = 10;   // in milliseconds
        tag.stepSize = tag.stepTime;
        tag.currentTimeout = null;

        function increment() {
            tag.value += tag.stepSize;
            tag.update();
            if (isFinished())
                opts.controller.trigger("timeout");
        }

        function scheduleNextStep() {
            if (!isFinished())
                tag.currentTimeout = setTimeout(() => {increment(); scheduleNextStep()}, tag.stepTime);
        }

        function stop() {
            if (tag.currentTimeout != null)
                clearTimeout(tag.currentTimeout);
        }

        function isFinished() {
            return tag.value >= tag.max;
        }

        opts.controller.on("start", scheduleNextStep);
        opts.controller.on("stop", stop);
    </script>

    <style>
        progress {width: 100%; box-sizing: border-box;}
    </style>

</timer>
